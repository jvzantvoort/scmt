---
# Kubernetes Deployment Configuration
# Generated on: {{.Timestamp}}
# Generated by: {{.Engineer}}

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{if .Config.SERVICE_NAME}}{{.Config.SERVICE_NAME}}{{else}}myapp{{end}}
  labels:
    app: {{if .Config.SERVICE_NAME}}{{.Config.SERVICE_NAME}}{{else}}myapp{{end}}
    environment: {{if .Config.ENVIRONMENT}}{{.Config.ENVIRONMENT}}{{else}}development{{end}}
    owner: "{{replace (lower .Config.OWNER) " " "-" -1}}"
spec:
  replicas: {{if eq .Config.ENVIRONMENT "production"}}3{{else}}1{{end}}
  selector:
    matchLabels:
      app: {{if .Config.SERVICE_NAME}}{{.Config.SERVICE_NAME}}{{else}}myapp{{end}}
  template:
    metadata:
      labels:
        app: {{if .Config.SERVICE_NAME}}{{.Config.SERVICE_NAME}}{{else}}myapp{{end}}
        {{range .Roles}}
        role-{{replace . "-" "" -1}}: "true"
        {{end}}
    spec:
      containers:
      - name: app
        image: {{if .Config.CONTAINER_IMAGE}}{{.Config.CONTAINER_IMAGE}}{{else}}nginx:latest{{end}}
        ports:
        {{if .HasRole "web-server"}}
        - containerPort: 80
          name: http
        {{end}}
        {{if .HasRole "database"}}
        - containerPort: 5432
          name: postgres
        {{end}}
        env:
        - name: SERVER_TYPE
          value: "{{.Config.TYPE}}"
        - name: OWNER
          value: "{{.Config.OWNER}}"
        - name: TIMEZONE
          value: "{{.Config.TIMEZONE}}"
        - name: ROLES
          value: "{{join .Roles ","}}"
        
{{if .HasRole "web-server"}}
---
apiVersion: v1
kind: Service
metadata:
  name: {{if .Config.SERVICE_NAME}}{{.Config.SERVICE_NAME}}{{else}}myapp{{end}}-service
spec:
  selector:
    app: {{if .Config.SERVICE_NAME}}{{.Config.SERVICE_NAME}}{{else}}myapp{{end}}
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
{{end}}